在index.js中添加登录路由

```js
router.post('/login',user.login); // 登录
```

在user.js中将登录函数进行导出

```js
exports.register = async (req, res) => {}
```

验证参数是否符合规则

```js
await schema.validateAsync(req.body).then((val) => {})
      .catch((error) => {
        return res.send({
          meta: { code: 1001, message: error.message },
          data: null,
        });
      });
```

根据邮箱查找用户

```js
// 根据用户邮箱查询是否存在
const user = await User.findOne({ email: req.body.email });
```

判断用户是否存在，如果不存在则返回

```js
 return res.send({
    meta: { code: 1001, message: '该用户不存在' },
    data: null,
 });
```

如果该用户存在，还要判断密码是否正确

```js
// 比对密码是否正确
const isVaild = await bcrypt.compare(req.body.password, user.password);
```

如果密码错误

```js
return res.send({
   meta: { code: 1001, message: '密码错误' },
   data: null,
 });
```

登录成功

```js
// 密码正确
res.send({
   meta: { code: 1000, message: '登录成功' },
   data: user,
});
```

![image-20210528221221056](http://img.yulings.top/20210528221222.png)

登录成功后，我们需要对用户进行授权，这里使用JWT方式来实现

安装jsonwebtoken

```shell
npm install jsonwebtoken
```

在user.js中引入

```shell
const jwt = require("jsonwebtoken");
```

使用

```js
const secretKey = 'yuling'
const token ="Bearer " + jwt.sign({ username: req.body.username, role: user.role}, secretKey, {
      expiresIn: 600 * 24 * 3,
});
```

在登录成功，返回的时候，把token一并返回

![image-20210529022128277](http://img.yulings.top/20210529022129.png)

改造一下，把secretKey提取出来，在根目录下创建一个config文件夹，并在里面创建一个index.js文件

写入以下代码

```js
const config = {
    // secret密钥,在jwt中会用到
    secretKey: 'hello yuling',
}
module.exports = config;
```

以后所有的通用变量都可以写在这里，方便修改

