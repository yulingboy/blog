之前写的注册接口代码太过于繁杂，尤其是对于字段的验证，所以需要进行优化。

这里我打算采用joi插件来对数据进行验证

安装

```shell
npm install joi
```

定义验证规则

```js
// 定义验证规则
const schema = joi.object({
  // username必须是字符串类型、最小长度是2、最大长度是6、必填项、自定义验证失败错误信息
  username: joi.string().min(2).max(6).required().error(new Error('用户名格式不正确')),
  // email必须是字符串类型、必须符合邮箱格式、必填项、自定义验证失败错误信息
  email: joi.string().email().required().error(new Error('邮箱格式不正确')),
  // password必须是字符串类型、必须符合指定的正则规则、自定义验证失败错误信息
  password: joi.string().regex(/^[a-zA-Z0-9]+$/).error(new Error('密码格式不正确'))
})
```

判断参数是否满足规则

```js
// validate方法验证参数是否符合规则
await schema.validateAsync(req.body).then(() => {
     }).catch((error) => {
            return res.send({
             meta: { code: 1001, message: error.message },
             data: null,
           });
})  
```

完整代码

```js
// 导入用户模型
const User = require('../models/user.js');
// 导入 joi
const joi = require('joi');

// 定义验证规则
const schema = joi.object({
  // username必须是字符串类型、最小长度是2、最大长度是6、必填项、自定义验证失败错误信息
  username: joi.string().min(2).max(6).required().error(new Error('用户名格式不正确')),
  // email必须是字符串类型、必须符合邮箱格式、必填项、自定义验证失败错误信息
  email: joi.string().email().required().error(new Error('邮箱格式不正确')),
  // password必须是字符串类型、必须符合指定的正则规则、自定义验证失败错误信息
  password: joi.string().regex(/^[a-zA-Z0-9]+$/).error(new Error('密码格式不正确')),
});

// 注册
exports.register = async (req, res) => {
  try {
    req.body = JSON.parse(JSON.stringify(req.body));
    // validate方法验证参数是否符合规则
    await schema.validateAsync(req.body)
    .then((val) => {})
      .catch((error) => {
        return res.send({
          meta: { code: 1001, message: error.message },
          data: null,
        });
      });

    // 在数据表中，我们规定了邮箱的唯一性，所以先根据注册邮箱查询该邮箱是否被注册
    const user = await User.findOne({ email: req.body.email });
    if (user) {
      // 如果user存在，说明该邮箱已经被注册过了，不能够再次用来注册
      return res.send({
        meta: { code: 1001, message: '该邮箱已经被占用' },
        data: null,
      });
    } else {
      // 如果user不存在，说明该邮箱没有被注册过，可以用来注册

      //   向数据库中写入
      const flag = await User.create(req.body);
      //   创建成功
      if (flag) {
        res.send({
          meta: { code: 1000, message: '注册成功' },
          data: null,
        });
      }else{  // 创建失败
        res.send({
            meta: { code: 1001, message: '注册失败' },
            data: null,
          }); 
      }
    }
  } catch (err) {
    res.send({
      meta: { code: 1001, message: err.message },
      data: null,
    });
  }
};

```

