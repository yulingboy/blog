在根目录下创建api文件夹，再在api文件夹下创建v1文件夹，这样方便以后重构。在v1文件夹下创建index.js，写入以下代码：

```js
// 导入express模块
const express = require('express');
// 创建路由实例
const router = express.Router();
// 将路由函数导入
const user = require('../../routes/user')

router.post('/register',user.register); // 注册
```

在根目录下创建routes文件夹，然后在里面创建user.js文件，并写入以下代码：

```js
// 导入用户模型
const User = require("../models/user.js");

// 注册
exports.register =  async (req,res)=>{
    res.send("hello world!");
}
```

在app.js中加入以下代码

```
// 导入路由
const v1 = require('./api/v1/index');
app.use('/api/v1/blog', v1);
```

启动服务器，打开postman，在地址栏中输入http://127.0.0.1:3000/api/v1/blog/register，请求方式选择post，发起请求，发现报错：

```shell
E:\此电脑\桌面\blog\server\node_modules\express\lib\router\index.js:458
      throw new TypeError('Router.use() requires a middleware function but got a ' + gettype(fn))
      ^

TypeError: Router.use() requires a middleware function but got a Object
    at Function.use (E:\此电脑\桌面\blog\server\node_modules\express\lib\router\index.js:458:13)
    at Function.<anonymous> (E:\此电脑\桌面\blog\server\node_modules\express\lib\application.js:220:21)
    at Array.forEach (<anonymous>)
    at Function.use (E:\此电脑\桌面\blog\server\node_modules\express\lib\application.js:217:7)
    at Object.<anonymous> (E:\此电脑\桌面\blog\server\app.js:9:5)
    at Module._compile (internal/modules/cjs/loader.js:1075:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1096:10)
    at Module.load (internal/modules/cjs/loader.js:940:32)
    at Function.Module._load (internal/modules/cjs/loader.js:781:14)
    at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:72:12)
    at internal/main/run_main_module.js:17:47
```

查看代码，发现api/v1/index.js没有把路由导出，添加代码

```js
// 将对进行导出
module.exports = router;
```

重启服务器，启动正常，没有报错，重新发起请求，没有报错，并且返回“hello world!”，说明代码运行正常，可以开始编写注册函数了。

我们使用`try...catch`来捕获错误。

emmm，有一个警告

```shell
(node:12344) DeprecationWarning: collection.ensureIndex is deprecated. Use createIndexes instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
```

在db.js中，链接服务器前面加入两行代码，就不会报错了

```js
mongoose.set('useCreateIndex', true)
mongoose.set('useFindAndModify', false)
```

在register函数中写入以下代码：

```js
try {
    //  先把用户注册必须要有的字段解构出来
    const { email, password, username } = req.body;
    // 判断邮箱是否满足格式要求
    const reg = '^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(.[a-zA-Z0-9-]+)*.[a-zA-Z0-9]{2,6}$';
    if (!reg.test(email)) {
      return res.send({
        meta: { code: 1000, message: '邮箱格式不合法' },
        data: null,
      });
    }
    // 在数据表中，我们规定了邮箱的唯一性，所以先根据注册邮箱查询该邮箱是否被注册
    const user = await User.findOne({ email: req.body.email });
    if (user) {
      // 如果user存在，说明该邮箱已经被注册过了，不能够再次用来注册
      return res.send({
        meta: { code: 1000, message: '该邮箱已经被占用' },
        data: null,
      });
    } else {
      // 如果user不存在，说明该邮箱没有被注册过，可以用来注册

      // 判断密码是否满足要求
      if (password.length < 6 || password.length > 12) {
        return res.send({
          meta: { code: 1000, message: '密码格式不符合要求' },
          data: null,
        });
      }
    //   判断用户名是否满足要求
      if (!username) {
        return res.send({
          meta: { code: 1000, message: '请输入用户名' },
          data: null,
        });
      }
    //   向数据库中写入
      const flag = await User.create(req.body);
    //   创建成功
      if (flag) {
        res.send({
          meta: { code: 1001, message: '注册用户成功' },
          data: null,
        });
      }
    }
  } catch (err) {
    res.send({
        meta: { code: 1000, message: err },
        data: null,
      });
  }
```

emmm，使用postman，发现没有注册成功，

![image-20210526223925304](http://img.yulings.top/20210526223933.png)

经过调试后发现req.body没有解析，默认为undefined。

安装body-parser

```shell
npm install body-parser
```

在app.js中加入以下代码

```js
var bodyParser = require('body-parser')
app.use(bodyParser.urlencoded({ extended: false }))
app.use(bodyParser.json())
```

重新测试，发现还是失败，通过代码调试，发现接收到的参数是这样的

```json
[Object: null prototype] {
  email: 'yuling@163.com',
  password: '123456',
  username: 'yuling'
}
```

我们可以先对对象进行JSON字符串转化(`JSON.stringify()`)，然后再转化成对象(`JSON.parse()`)，这样就可以去除了

啊这，调试后，发现不是这里的问题。。。

经过一番辛苦调试，发现是正则表达式写错了，瞧我这猪脑子

应该是

```js
/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(.[a-zA-Z0-9-]+)*.[a-zA-Z0-9]{2,6}$/
```

而不是字符串

```js
'^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(.[a-zA-Z0-9-]+)*.[a-zA-Z0-9]{2,6}$'
```

注册成功！

![image-20210526231048156](http://img.yulings.top/20210526231049.png)

查看数据库，里面也有了数据

![image-20210526231241711](http://img.yulings.top/20210526231242.png)